worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    log_format grpc_json escape=json '{'
        '"time":"$time_iso8601",'
        '"client":"$remote_addr",'
        '"uri":"$uri",'
        '"status":"$status",'
        '"grpc_status":"$sent_http_grpc_status",'
        '"request_time":"$request_time",'
        '"upstream":"$upstream_addr",'
        '"upstream_response_time":"$upstream_response_time"'
    '}';

    access_log /var/log/nginx/access.log grpc_json;

    # Upstream for chat servers - uses Docker DNS for service discovery
    upstream grpc_servers {
        # Least connections works well for long-lived gRPC streams
        least_conn;

        # Docker Compose DNS resolves 'chat.server' to all replicas
        # keepalive connections to reduce connection overhead
        server chat.server:8080 max_fails=3 fail_timeout=30s;

        keepalive 100;
        keepalive_requests 10000;
        keepalive_time 1h;
        keepalive_timeout 60s;
    }

    server {
        listen 8080 http2;

        # gRPC requires HTTP/2
        http2_max_concurrent_streams 1000;

        # Keep idle HTTP/2 connections alive longer
        http2_recv_timeout 3600s;
        http2_idle_timeout 3600s;

        # Client-side timeouts
        client_body_timeout 3600s;
        client_header_timeout 60s;

        # Health check endpoint for the load balancer itself
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Proxy health check to upstream
        location /health/ {
            grpc_pass grpc://grpc_servers;
            grpc_connect_timeout 5s;
            grpc_read_timeout 10s;
        }

        # All gRPC traffic
        location / {
            grpc_pass grpc://grpc_servers;

            # Timeouts for long-lived streaming connections
            grpc_connect_timeout 10s;
            grpc_read_timeout 3600s;    # 1 hour for streaming
            grpc_send_timeout 3600s;

            # TCP keepalive to prevent connection drops
            grpc_socket_keepalive on;

            # Buffer settings
            grpc_buffer_size 64k;

            # Pass headers
            grpc_set_header Host $host;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Error handling
            error_page 502 = /error502grpc;
        }

        # Custom error for gRPC when backend is unavailable
        location = /error502grpc {
            internal;
            default_type application/grpc;
            add_header grpc-status 14;  # UNAVAILABLE
            add_header grpc-message "Backend unavailable";
            return 204;
        }
    }
}